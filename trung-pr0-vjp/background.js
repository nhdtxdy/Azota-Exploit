var screenSaveCount = 0;
var scoreHack = false;
var honestQuestionCount = 0;
var azotaProxyServer = "https://localhost:6520";

chrome.browserAction.setBadgeText({text: screenSaveCount.toString()});

const trackerLink = "https://api.azota.vn/api/FrontExamTrack/SaveObj";
const resultLink = "https://api.azota.vn/api/FrontExamResult/SaveObj";
const azotaApiServer = "https://api.azota.vn";

var incrementScreenSaveCallback = null;

function incrementScreenSaveCount() 
{
    ++screenSaveCount;
    if (incrementScreenSaveCallback)
    {
        incrementScreenSaveCallback(screenSaveCount);
    }
    chrome.browserAction.setBadgeText({text: screenSaveCount.toString()});
}

chrome.webRequest.onBeforeRequest.addListener(
    function(details) {
        console.log("onBeforeRequest: " + details.url);

        console.log(details);

        if (!details.requestBody)
        {
            return;
        }

        var decoder = new TextDecoder("utf-8");
        var decoded = decoder.decode(details.requestBody.raw[0].bytes);

        var payload = JSON.parse(decoded);
        console.log(payload);

        if (details.url.startsWith(trackerLink))
        {
            if (payload.name)
            {
                switch (payload.name)
                {
                    case "exit_full_screen":
                    case "re_open_full_screen":
                        console.log("Blocked screen tracking request.");
                        incrementScreenSaveCount();
                        return {cancel: true};
                }    
            }
        }

        if (scoreHack && details.url.startsWith(resultLink) && details.method == "POST")
        {
            console.log("Redirecting submission to " + azotaProxyServer + "...");
            console.log(details.url.replace(azotaApiServer, azotaProxyServer) + "&honestQuestionCount=" + honestQuestionCount);
            return {redirectUrl: details.url.replace(azotaApiServer, azotaProxyServer) + "&honestQuestionCount=" + honestQuestionCount};
        }
    },
    {
        urls: [
            "*://api.azota.vn/*",
            "*://azota.vn/*"
        ],
        types: ["main_frame", "sub_frame", "stylesheet", "script", "image", "object", "xmlhttprequest", "other"]
    },
    ["blocking", "requestBody"]
);